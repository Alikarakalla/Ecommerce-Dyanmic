@if (isAdmin()) {
  <div class="admin-dashboard">
    <header class="admin-dashboard__hero">
      <div class="admin-dashboard__intro">
        <h1>Store performance</h1>
        <p>Track what is live in your catalog and monitor customer activity without leaving the dashboard.</p>
        <div class="admin-dashboard__actions">
          <button type="button" class="button button--ghost" (click)="navigateToStore()">View store</button>
        </div>
      </div>
      <section class="admin-dashboard__metrics">
        <article class="metric">
          <span class="metric__label">Products</span>
          <span class="metric__value">{{ totalProducts() }}</span>
          <small class="metric__hint">Currently available in the storefront</small>
        </article>
        <article class="metric">
          <span class="metric__label">Orders</span>
          <span class="metric__value">{{ totalOrders() }}</span>
          <small class="metric__hint">All time customer purchases</small>
        </article>
        <article class="metric">
          <span class="metric__label">Customers</span>
          <span class="metric__value">{{ totalUsers() }}</span>
          <small class="metric__hint">Registered storefront accounts</small>
        </article>
        <article class="metric">
          <span class="metric__label">Revenue</span>
          <span class="metric__value">{{ totalRevenue() | currency }}</span>
          <small class="metric__hint">Sum of recorded orders</small>
        </article>
      </section>
    </header>

    <main class="admin-dashboard__content">
      @if (!hasSite()) {
        <div class="admin-dashboard__empty">
          <h2>No products yet</h2>
          <p>Start by creating products from the storefront to populate this dashboard.</p>
        </div>
      } @else {
        <form class="dashboard-section dashboard-section--form" [formGroup]="productManagerForm" (ngSubmit)="saveProductChanges()">
          <header class="dashboard-section__header">
            <div>
              <h2>Product management</h2>
              <p>Create, update, or remove items from the storefront catalog.</p>
            </div>
            <div class="product-form__toolbar">
              <span class="dashboard-section__meta">{{ totalProducts() }} live</span>
              <button type="button" class="button button--secondary" (click)="addProduct()">Add product</button>
            </div>
          </header>

          <div class="product-manager" formArrayName="products">
            <div class="product-manager__grid">
              <aside class="product-library" [class.product-library--empty]="!productsArray.length">
                @if (productsArray.length) {
                  <ul class="product-library__list">
                    @for (productCtrl of productsArray.controls; track trackProductControl($index)) {
                      <li class="product-library__item">
                        <button
                          type="button"
                          class="product-tile"
                          [class.product-tile--active]="isSelected($index)"
                          (click)="selectProduct($index)"
                        >
                          <figure class="product-tile__media">
                            <img
                              [src]="previewImage(productCtrl)"
                              [alt]="productCtrl.controls.name.value || ('Product ' + ($index + 1))"
                            />
                          </figure>
                          <div class="product-tile__body">
                            <span class="product-tile__title">
                              {{ productCtrl.controls.name.value || ('Product ' + ($index + 1)) }}
                            </span>
                            <span class="product-tile__meta">
                              {{ productCtrl.controls.highlight.value || productCtrl.controls.category.value || 'No category' }}
                            </span>
                          </div>
                        </button>
                      </li>
                    }
                  </ul>
                } @else {
                  <p class="product-library__empty">No products in the list yet. Use "Add product" to create one.</p>
                }
              </aside>

              <section class="product-editor" *ngIf="selectedProduct() as selected; else productSelectionPrompt">
                <ng-container [formGroupName]="selectedProductIndex()!">
                  <header class="product-editor__header">
                    <div>
                      <h3>{{ selected.controls.name.value || 'Untitled product' }}</h3>
                      <span class="product-editor__hint">
                        {{ selected.controls.slug.value || 'Slug generated on save' }}
                      </span>
                    </div>
                    <div class="product-editor__actions">
                      <button type="button" class="button button--danger" (click)="removeProduct(selectedProductIndex()!)">
                        Delete
                      </button>
                    </div>
                  </header>\n                  <div class="product-editor__grid">
                    <label class="product-field">
                      <span>Name</span>
                      <input type="text" formControlName="name" placeholder="Everyday Tote" />
                      @if (selected.controls.name.invalid && selected.controls.name.touched) {
                        <small class="product-field__error">Name is required.</small>
                      }
                    </label>

                    <label class="product-field">
                      <span>Highlight</span>
                      <input type="text" formControlName="highlight" placeholder="Limited Release" />
                    </label>

                    <label class="product-field">
                      <span>Price</span>
                      <input type="number" inputmode="decimal" min="0" step="0.01" formControlName="price" />
                      @if (selected.controls.price.invalid && selected.controls.price.touched) {
                        <small class="product-field__error">Enter a price of 0 or more.</small>
                      }
                    </label>

                    <label class="product-field">
                      <span>Slug</span>
                      <input type="text" formControlName="slug" placeholder="everyday-tote" />
                    </label>

                    <label class="product-field">
                      <span>Category</span>
                      <input type="text" formControlName="category" placeholder="Apparel" />
                    </label>

                    <label class="product-field">
                      <span>Sub category</span>
                      <input type="text" formControlName="subCategory" placeholder="Outerwear" />
                    </label>

                    <label class="product-field product-field--full">
                      <span>Description</span>
                      <textarea formControlName="description" rows="3" placeholder="Describe the product features"></textarea>
                      @if (selected.controls.description.invalid && selected.controls.description.touched) {
                        <small class="product-field__error">Description must be between 30 and 250 characters.</small>
                      }
                    </label>

                    <label class="product-field product-field--full">
                      <span>Main image URL</span>
                      <input type="url" formControlName="imageUrl" placeholder="https://images.unsplash.com/..." />
                      @if (selected.controls.imageUrl.invalid && selected.controls.imageUrl.touched) {
                        <small class="product-field__error">Image URL is required.</small>
                      }
                    </label>

                    <label class="product-field product-field--full">
                      <span>Gallery images</span>
                      <textarea formControlName="gallery" rows="3" placeholder="Add one URL per line"></textarea>
                    </label>

                    <label class="product-field product-field--full">
                      <span>Available sizes</span>
                      <textarea formControlName="sizes" rows="2" placeholder="S&#10;M&#10;L"></textarea>
                    </label>

                    <label class="product-field product-field--full">
                      <span>Available colors</span>
                      <textarea formControlName="colors" rows="2" placeholder="Charcoal&#10;Sand"></textarea>
                    </label>
                  </div>
                </ng-container>
              </section>
            </div>
          </div>

          <div class="product-form__footer">
            <div class="product-form__status">
              @if (hasUnsavedProductChanges()) {
                <span class="status-pill status-pill--warning">Unsaved changes</span>
              }
              @if (productSaveState() === 'saved') {
                <span class="status-pill status-pill--success">Products updated</span>
              }
            </div>
            <button type="submit" class="button button--primary" [disabled]="productManagerForm.invalid || !hasUnsavedProductChanges()">
              Save products
            </button>
          </div>
        </form>

        <section class="dashboard-section">
          <header class="dashboard-section__header">
            <div>
              <h2>Recent orders</h2>
              <p>Latest purchase activity</p>
            </div>
            <span class="dashboard-section__meta">{{ totalOrders() }} total</span>
          </header>
          @if (recentOrders().length) {
            <ul class="dashboard-list">
              @for (order of recentOrders(); track trackOrder($index, order)) {
                <li class="dashboard-card">
                  <div class="dashboard-card__primary">
                    <h3>Order #{{ order.id.slice(-6).toUpperCase() }}</h3>
                    <span class="dashboard-card__muted">{{ order.placedAt | date: 'medium' }}</span>
                  </div>
                  <div class="dashboard-card__secondary">
                    <span class="dashboard-card__muted">{{ order.customerName }}</span>
                    <span class="dashboard-card__value">{{ order.total | currency }}</span>
                  </div>
                </li>
              }
            </ul>
          } @else {
            <p class="dashboard-empty">No customer orders have been recorded yet.</p>
          }
        </section>

        <section class="dashboard-section">
          <header class="dashboard-section__header">
            <div>
              <h2>Recent customers</h2>
              <p>Latest registered accounts</p>
            </div>
            <span class="dashboard-section__meta">{{ totalUsers() }} total</span>
          </header>
          @if (latestUsers().length) {
            <ul class="dashboard-list">
              @for (user of latestUsers(); track trackUser($index, user)) {
                <li class="dashboard-card">
                  <div class="dashboard-card__primary">
                    <h3>{{ user.name }}</h3>
                    <span class="dashboard-card__muted">{{ user.email }}</span>
                  </div>
                  <div class="dashboard-card__secondary">
                    <span class="dashboard-chip" [class.dashboard-chip--admin]="user.role === 'admin'">
                      {{ user.role === 'admin' ? 'Admin' : 'Customer' }}
                    </span>
                    @if (user.phone) {
                      <span class="dashboard-card__muted">{{ user.phone }}</span>
                    }
                  </div>
                </li>
              }
            </ul>
          } @else {
            <p class="dashboard-empty">No customers have registered yet.</p>
          }
        </section>
      }
    </main>
  </div>
} @else {
  <div class="admin-dashboard__unauthorized">
    <h2>Restricted access</h2>
    <p>You need an administrator account to view the dashboard.</p>
  </div>
}

<ng-template #productSelectionPrompt>
  <div class="product-editor product-editor--empty">
    <p>Select a product from the list to start editing.</p>
  </div>
</ng-template>





